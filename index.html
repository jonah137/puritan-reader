<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Ê∏ÖÊïôÂæíÁªèÂÖ∏ÈòÖËØª</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=Noto+Sans+SC:wght@400;500;600;700&family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
  <style>
:root{
  --bg:#faf8f4;--bg2:#f2ede6;--card:#fff;--text:#2a2a2a;--text2:#777;--text3:#aaa;
  --accent:#7b3f00;--accent2:#a05a20;--accent-bg:rgba(123,63,0,.06);
  --border:#e8e0d4;--border2:#d8cfc2;--shadow:0 1px 4px rgba(0,0,0,.06);
  --sidebar-w:280px;--reader-max:720px;
  --serif:"Noto Serif SC","Source Han Serif SC","Songti SC",Georgia,serif;
  --sans:"Noto Sans SC","Source Han Sans SC","PingFang SC","Microsoft YaHei",sans-serif;
  --kai:"ZCOOL XiaoWei","KaiTi","STKaiti","Ê•∑‰Ωì",serif;
  --reading-font:var(--serif);
}
[data-theme="dark"]{
  --bg:#141414;--bg2:#1c1c1c;--card:#202020;--text:#d8d0c8;--text2:#888;--text3:#555;
  --accent:#d4a060;--accent2:#e0b878;--accent-bg:rgba(212,160,96,.08);
  --border:#2e2e2e;--border2:#3a3a3a;--shadow:0 1px 4px rgba(0,0,0,.25);
}
*{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth}
body{font-family:var(--serif);background:var(--bg);color:var(--text);line-height:1.9;font-size:17px;transition:background .3s,color .3s;-webkit-text-size-adjust:100%;overflow-x:hidden}
#app{display:flex;min-height:100vh}
#sidebar{width:var(--sidebar-w);min-height:100vh;background:var(--bg2);border-right:1px solid var(--border);overflow-y:auto;position:fixed;left:0;top:0;bottom:0;z-index:50;transition:transform .3s}
#sidebar.hidden{transform:translateX(-100%)}
#main{flex:1;margin-left:var(--sidebar-w);transition:margin .3s}
#main.full{margin-left:0}
.sb-head{padding:20px;border-bottom:1px solid var(--border);text-align:center}
.sb-head h1{font-size:17px;color:var(--accent);letter-spacing:3px;font-weight:700}
.sb-head .sub{font-size:10px;color:var(--text3);margin-top:2px;letter-spacing:1px}
.sb-tabs{display:flex;border-bottom:1px solid var(--border)}
.sb-tab{flex:1;padding:10px 0;text-align:center;font-size:13px;color:var(--text2);cursor:pointer;transition:all .15s;border-bottom:2px solid transparent}
.sb-tab:hover{color:var(--accent)}
.sb-tab.act{color:var(--accent);border-bottom-color:var(--accent);font-weight:600}
.sb-panel{display:none;padding:6px 0}
.sb-panel.act{display:block}
.sb-nav{padding:6px 0}
.sb-author{padding:9px 16px;font-size:14px;font-weight:600;color:var(--text);cursor:pointer;display:flex;align-items:center;gap:6px;transition:background .15s;user-select:none}
.sb-author:hover{background:var(--accent-bg)}
.sb-author .arr{font-size:9px;color:var(--text3);transition:transform .2s;display:inline-block}
.sb-author.open .arr{transform:rotate(90deg)}
.sb-books{overflow:hidden;max-height:0;transition:max-height .3s ease}
.sb-author.open+.sb-books{max-height:2000px}
.sb-book{padding:7px 16px 7px 32px;font-size:13px;color:var(--text2);cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:5px;user-select:none}
.sb-book:hover{color:var(--accent);background:var(--accent-bg)}
.sb-book.active{color:var(--accent);font-weight:600;background:var(--accent-bg)}
.sb-book .arr{font-size:8px;color:var(--text3);transition:transform .2s;display:inline-block}
.sb-book.open .arr{transform:rotate(90deg)}
.sb-chs{overflow:hidden;max-height:0;transition:max-height .3s ease}
.sb-book.open+.sb-chs{max-height:2000px}
.sb-ch{padding:5px 16px 5px 48px;font-size:12px;color:var(--text3);cursor:pointer;transition:color .15s;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sb-ch:hover{color:var(--accent)}
.sb-ch.active{color:var(--accent);font-weight:600}
.bm-item{padding:10px 16px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s;position:relative}
.bm-item:hover{background:var(--accent-bg)}
.bm-item .bm-title{font-size:13px;color:var(--text);font-weight:600;margin-bottom:2px}
.bm-item .bm-info{font-size:11px;color:var(--text3)}
.bm-item .bm-del{position:absolute;right:12px;top:50%;transform:translateY(-50%);font-size:14px;color:var(--text3);cursor:pointer;padding:4px;border-radius:4px;opacity:0;transition:all .15s}
.bm-item:hover .bm-del{opacity:1}
.bm-item .bm-del:hover{color:#c44;background:rgba(200,60,60,.1)}
#topbar{position:sticky;top:0;z-index:40;background:var(--bg);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;padding:8px 12px;backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px)}
.ic{width:36px;height:36px;border:none;background:none;border-radius:8px;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;color:var(--text2);transition:all .15s;flex-shrink:0}
.ic:hover{background:var(--accent-bg);color:var(--accent)}
.ic.bookmarked{color:var(--accent)}
#crumb{flex:1;font-size:13px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
#crumb span{cursor:pointer;transition:color .15s}
#crumb span:hover{color:var(--accent)}
#crumb .sep{color:var(--text3);margin:0 4px;cursor:default}
#search-input{width:0;opacity:0;border:1px solid var(--border);border-radius:20px;padding:6px 14px;font-size:13px;background:var(--card);color:var(--text);font-family:var(--serif);outline:none;transition:all .3s}
#search-input.open{width:180px;opacity:1}
#search-input:focus{border-color:var(--accent)}
.view{display:none;padding:24px;max-width:var(--reader-max);margin:0 auto}
.view.active{display:block;animation:fadeUp .25s ease}
@keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.shelf-title{font-size:22px;font-weight:700;color:var(--accent);margin-bottom:4px;letter-spacing:2px}
.shelf-sub{font-size:13px;color:var(--text3);margin-bottom:28px}
.a-section{margin-bottom:28px}
.a-section h2{font-size:15px;font-weight:600;margin-bottom:10px;color:var(--text);display:flex;align-items:baseline;gap:8px}
.a-section h2 .en{font-size:11px;font-weight:400;color:var(--text3);font-style:italic}
.b-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px}
.b-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden;box-shadow:var(--shadow)}
.b-card:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(0,0,0,.1);border-color:var(--accent)}
.b-card .t{font-size:15px;font-weight:600;color:var(--text);margin-bottom:4px;line-height:1.4}
.b-card .m{font-size:11px;color:var(--text3)}
.b-card .resume{font-size:11px;color:var(--accent);margin-top:6px;display:flex;align-items:center;gap:4px}
.b-card .resume::before{content:'‚ñ∂';font-size:8px}
.b-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:4px;background:var(--accent);opacity:0;transition:opacity .2s}
.b-card:hover::before{opacity:1}
.toc-hdr{margin-bottom:20px}
.toc-hdr h2{font-size:20px;font-weight:700;color:var(--text)}
.toc-hdr .meta{font-size:13px;color:var(--text2);margin-top:4px}
.toc-list{list-style:none}
.toc-item{padding:14px 16px;border-bottom:1px solid var(--border);cursor:pointer;display:flex;align-items:center;gap:12px;transition:background .15s}
.toc-item:hover{background:var(--accent-bg)}
.toc-item .n{width:28px;height:28px;border-radius:50%;background:var(--accent-bg);display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--accent);font-weight:600;flex-shrink:0}
.toc-item .ct{font-size:15px;color:var(--text);flex:1;line-height:1.4}
.toc-item .cc{font-size:11px;color:var(--text3)}
.toc-item .read-dot{width:6px;height:6px;border-radius:50%;background:var(--accent);flex-shrink:0}
#rv .ch-title{font-size:20px;font-weight:700;color:var(--accent);margin-bottom:24px;padding-bottom:12px;border-bottom:1px solid var(--border);letter-spacing:1px}
.para{margin-bottom:18px;text-indent:2em;line-height:2;text-align:justify;font-family:var(--reading-font)}
.rnav{display:flex;justify-content:space-between;align-items:center;padding:24px 0;margin-top:16px;border-top:1px solid var(--border);gap:8px}
.rnav button{padding:8px 16px;border:1px solid var(--border);border-radius:6px;background:var(--card);color:var(--text);cursor:pointer;font-size:13px;font-family:var(--serif);transition:all .15s;max-width:40%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.rnav button:hover{border-color:var(--accent);color:var(--accent)}
.rnav button:disabled{opacity:.3;cursor:not-allowed}
.rnav .pi{font-size:12px;color:var(--text3);flex-shrink:0}
.sr{padding:12px 16px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s}
.sr:hover{background:var(--accent-bg)}
.sr .st{font-size:12px;color:var(--accent);margin-bottom:3px}
.sr .sx{font-size:14px;color:var(--text);line-height:1.7}
.sr mark{background:rgba(212,160,96,.3);color:var(--accent);padding:0 2px;border-radius:2px}
.empty{text-align:center;padding:48px 0;color:var(--text3);font-size:14px}
#set-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.25);z-index:55}
#set-overlay.show{display:block}
#settings{position:fixed;right:-320px;top:0;bottom:0;width:300px;background:var(--card);border-left:1px solid var(--border);z-index:60;padding:24px;transition:right .3s;overflow-y:auto;box-shadow:-2px 0 12px rgba(0,0,0,.08)}
#settings.open{right:0}
.sg{margin-bottom:18px}
.sg label{font-size:13px;color:var(--text2);display:block;margin-bottom:8px}
.sg input[type=range]{width:100%;accent-color:var(--accent)}
.sr2{display:flex;gap:8px;flex-wrap:wrap}
.sb{padding:6px 14px;border:1px solid var(--border);border-radius:6px;background:var(--card);color:var(--text);cursor:pointer;font-size:13px;transition:all .15s}
.sb:hover,.sb.act{border-color:var(--accent);color:var(--accent);background:var(--accent-bg)}
.close-btn{position:absolute;top:16px;right:16px;width:28px;height:28px;border:none;background:none;font-size:18px;cursor:pointer;color:var(--text2);border-radius:6px;display:flex;align-items:center;justify-content:center}
.close-btn:hover{background:var(--accent-bg);color:var(--accent)}
#toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px 20px;font-size:13px;color:var(--text);box-shadow:0 4px 16px rgba(0,0,0,.15);z-index:200;transition:transform .3s ease;pointer-events:none}
#toast.show{transform:translateX(-50%) translateY(0)}
#overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:45}
#overlay.show{display:block}
::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
#pbar{position:fixed;top:0;left:0;height:2px;background:var(--accent);z-index:100;transition:width .15s;width:0}
#hl-toolbar{display:none;position:absolute;z-index:80;background:var(--card);border:1px solid var(--border);border-radius:8px;padding:4px;box-shadow:0 4px 16px rgba(0,0,0,.15);gap:4px;align-items:center}
#hl-toolbar.show{display:flex}
.hl-btn{width:24px;height:24px;border-radius:50%;border:2px solid transparent;cursor:pointer;transition:transform .15s}
.hl-btn:hover{transform:scale(1.2)}
.hl-btn.del{background:none;border:1px solid var(--border);font-size:12px;display:flex;align-items:center;justify-content:center;border-radius:4px;width:auto;padding:2px 6px;color:var(--text3)}
.hl-btn.del:hover{color:#c44;border-color:#c44}
.hl-y{background:rgba(255,235,59,.35)}
.hl-g{background:rgba(76,175,80,.25)}
.hl-b{background:rgba(66,165,245,.25)}
.hl-p{background:rgba(236,64,122,.2)}
.hl-item{padding:10px 16px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s}
.hl-item:hover{background:var(--accent-bg)}
.hl-item .hl-text{font-size:13px;color:var(--text);line-height:1.5;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.hl-item .hl-meta{font-size:11px;color:var(--text3);margin-top:3px}
.hl-item .hl-color{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:4px;vertical-align:middle}
.loading{text-align:center;padding:48px 0;color:var(--text3)}
.spinner{display:inline-block;width:24px;height:24px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite;margin-bottom:8px}
@keyframes spin{to{transform:rotate(360deg)}}
@media(max-width:768px){
  #sidebar{transform:translateX(-100%);width:85vw;max-width:320px}
  #sidebar.vis{transform:translateX(0)}
  #main{margin-left:0!important}
  .b-grid{grid-template-columns:1fr}
  .view{padding:14px 12px}
  #search-input.open{width:120px}
  .rnav{flex-wrap:wrap;justify-content:center}
  .rnav button{padding:8px 12px;font-size:13px;max-width:100%}
  #settings{width:85vw;max-width:300px;right:-90vw}
  #settings.open{right:0}
  .shelf-title{font-size:18px}
  .shelf-sub{font-size:12px;margin-bottom:16px}
  .a-section h2{font-size:14px}
  .b-card{padding:12px}
  .b-card .t{font-size:14px}
  .toc-item{padding:12px}
  .toc-item .ct{font-size:14px}
  #rv .ch-title{font-size:17px;margin-bottom:16px;padding-bottom:10px}
  .para{font-size:16px;margin-bottom:14px;text-indent:1.5em;line-height:1.9}
  .ic{width:32px;height:32px;font-size:16px}
  #crumb{font-size:12px}
  #topbar{padding:6px 8px;gap:4px}
  body{font-size:15px}
}
@media(max-width:380px){
  .b-card .t{font-size:13px}
  .view{padding:10px 8px}
  .para{font-size:15px;text-indent:1em}
  #topbar{padding:4px 6px;gap:2px}
  .ic{width:28px;height:28px;font-size:14px}
  #crumb{font-size:11px}
  #search-input.open{width:90px}
}
  </style>
</head>
<body>
<div id="pbar"></div>
<div id="app">
  <div id="sidebar" class="hidden">
    <div class="sb-head">
      <h1>Ê∏ÖÊïôÂæí</h1>
      <div class="sub">PURITAN CLASSICS</div>
    </div>
    <div class="sb-tabs">
      <div class="sb-tab act" onclick="sbTab(0,this)">ÁõÆÂΩï</div>
      <div class="sb-tab" onclick="sbTab(1,this)">‰π¶Á≠æ</div>
      <div class="sb-tab" onclick="sbTab(2,this)">ÂàíÁ∫ø</div>
    </div>
    <div id="sb-p0" class="sb-panel act sb-nav"></div>
    <div id="sb-p1" class="sb-panel"></div>
    <div id="sb-p2" class="sb-panel"></div>
  </div>
  <div id="main" class="full">
    <div id="topbar">
      <button class="ic" onclick="toggleSB()" id="hmenu">‚ò∞</button>
      <button class="ic" onclick="goBack()" id="back" style="display:none">‚Üê</button>
      <div id="crumb"></div>
      <button class="ic" onclick="toggleSrch()">üîç</button>
      <input id="search-input" type="text" placeholder="ÊêúÁ¥¢..." onkeyup="onSrch()">
      <button class="ic" id="bm-btn" onclick="toggleBM()">‚òÜ</button>
      <button class="ic" onclick="openSets()">‚öô</button>
    </div>
    <div id="sv" class="view active"></div>
    <div id="tv" class="view"></div>
    <div id="rv" class="view"></div>
    <div id="xv" class="view"></div>
  </div>
</div>

<div id="hl-toolbar">
  <button class="hl-btn" style="background:#ffeb3b" onclick="applyHL('y')"></button>
  <button class="hl-btn" style="background:#4caf50" onclick="applyHL('g')"></button>
  <button class="hl-btn" style="background:#42a5f5" onclick="applyHL('b')"></button>
  <button class="hl-btn" style="background:#ec409e" onclick="applyHL('p')"></button>
  <button class="hl-btn del" onclick="removeHL()">Âà†Èô§</button>
</div>

<div id="overlay" onclick="closeMobile()"></div>
<div id="set-overlay" onclick="closeSets()"></div>

<div id="settings">
  <button class="close-btn" onclick="closeSets()">‚úï</button>
  <div class="sg">
    <label>Â≠ó‰ΩìÂ§ßÂ∞è: <span id="fs-val">17</span>px</label>
    <input type="range" min="14" max="24" value="17" onchange="setFS(this.value)" oninput="setFS(this.value)">
  </div>
  <div class="sg">
    <label>Ë°åË∑ù: <span id="lh-val">1.9</span></label>
    <input type="range" min="1.5" max="2.5" step="0.1" value="1.9" onchange="setLH(this.value)" oninput="setLH(this.value)">
  </div>
  <div class="sg">
    <label>Â≠ó‰Ωì</label>
    <div class="sr2">
      <button class="sb act" onclick="setFF('serif',this)">Ë°¨Á∫ø</button>
      <button class="sb" onclick="setFF('sans',this)">Êó†Ë°¨Á∫ø</button>
      <button class="sb" onclick="setFF('kai',this)">Ê•∑‰Ωì</button>
    </div>
  </div>
  <div class="sg">
    <label>ÁÆÄÁπÅ‰Ωì</label>
    <div class="sr2">
      <button class="sb act" onclick="setSC('s',this)">ÁÆÄ‰Ωì</button>
      <button class="sb" onclick="setSC('t',this)">ÁπÅ‰Ωì</button>
    </div>
  </div>
  <div class="sg">
    <label>‰∏ªÈ¢ò</label>
    <div class="sr2">
      <button class="sb act" onclick="setTh('light',this)">‰∫ÆËâ≤</button>
      <button class="sb" onclick="setTh('dark',this)">Ê∑±Ëâ≤</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
const S2T_MAP={'‰∏≠':'‰∏≠','ÂõΩ':'Âúã','‰π¶':'Êõ∏','ËØ¥':'Ë™™','Â≠¶':'Â≠∏','ÁöÑ':'ÁöÑ','Áîü':'Áîü','‰∫∫':'‰∫∫','Êó∂':'ÊôÇ','ÊÄß':'ÊÄß','ÊÄù':'ÊÄù','ÁêÜ':'ÁêÜ','‰ø°':'‰ø°','Êïô':'Êïô','‰ºö':'ÊúÉ','Á•û':'Á•û','ÈÅì':'ÈÅì','‰∏ª':'‰∏ª','Â§©':'Â§©','Âú£':'ËÅñ','Á∫¶':'Á¥Ñ','Êóß':'Ëàä','Êñ∞':'Êñ∞','Áªè':'Á∂ì','‰πâ':'Áæ©','ÂñÑ':'ÂñÑ','ÊÅ∂':'ÊÉ°','ÂøÉ':'ÂøÉ','ÁÅµ':'Èùà','È≠Ç':'È≠Ç','Ëßâ':'Ë¶∫','ÊÇî':'ÊÇî','Êîπ':'Êîπ','‰ª∞':'‰ª∞','Ë°å':'Ë°å','‰∏∫':'ÁÇ∫','Âæ∑':'Âæ∑','ÂìÅ':'ÂìÅ','‰øÆ':'‰øÆ','ÂÖª':'È§ä','Âäõ':'Âäõ','Èáè':'Èáè','ÂÜ≥':'Ê±∫','ÂÆö':'ÂÆö','ÂÖ≥':'Èóú','ÈîÆ':'Èçµ','Èáç':'Èáç','Ë¶Å':'Ë¶Å','Êô∫':'Êô∫','ÊÖß':'ÊÖß','Áü•':'Áü•','ËØÜ':'Ë≠ò','Áúü':'Áúü','ÂØª':'Â∞ã','Ê±Ç':'Ê±Ç','Ê∞∏':'Ê∞∏','ÊÅí':'ÊÅÜ','ÂÖâ':'ÂÖâ','Êòé':'Êòé','Êöó':'Êöó','ÂΩ±':'ÂΩ±','Ë±°':'Ë±°','ÂæÅ':'Âæµ','ÂØì':'ÂØì','ÊÑè':'ÊÑè','Âê´':'Âê´','Ëï¥':'Ëòä','Ê∑±':'Ê∑±','Âàª':'Âàª','Á≤æ':'Á≤æ','Â¶ô':'Â¶ô','Â§Ñ':'Ëôï','Â§ç':'Âæ©','ÊùÇ':'Èõú','ÁÆÄ':'Á∞°','Âçï':'ÂñÆ','Áõ¥':'Áõ¥','Áéá':'Áéá','Êú¥':'Ê®∏','Á¥†':'Á¥†','Âº•':'ÂΩå','Ë°•':'Ë£ú','ÂÆå':'ÂÆå','Áæé':'Áæé','ÂÆπ':'ÂÆπ','ËÆ∏':'Ë®±','Âùö':'Â†Ö','ÊåÅ':'ÊåÅ','Êòæ':'È°Ø','Èú≤':'Èú≤','Èöê':'Èö±','ÂØÜ':'ÂØÜ','Áßò':'Áßò','Ëé´':'Ëé´','Âêç':'Âêç','Â£∞':'ËÅ≤','Ë™â':'Ë≠Ω','Ëç£':'Ê¶Æ','Ëæ±':'Ëæ±','Ë§í':'Ë§í','Ë¥¨':'Ë≤∂','Êâπ':'Êâπ','ËØÑ':'Ë©ï','ËÆ∫':'Ë´ñ','Ëø∞':'Ëø∞','ËÆ∞':'Ë®ò','ÂéÜ':'Ê≠∑','Âè≤':'Âè≤','‰∫ã':'‰∫ã','‰ª∂':'‰ª∂','Ëøá':'ÈÅé','Á®ã':'Á®ã','Èò∂':'Èöé','ÊÆµ':'ÊÆµ','Â±Ç':'Â±§','Ê¨°':'Ê¨°','ÈÄí':'ÈÅû','Ëøõ':'ÈÄ≤','Â±ï':'Â±ï','ÂºÄ':'Èñã','Êäò':'Êäò','Á£®':'Á£®','‰πê':'Ê®Ç','Âøß':'ÊÜÇ','Ê¨¢':'Ê≠°','ÊÑÅ':'ÊÑÅ','Âñú':'Âñú','ÊÄí':'ÊÄí','ÂìÄ':'ÂìÄ','ÊÉÖ':'ÊÉÖ','ÊÑü':'ÊÑü','Áà±':'ÊÑõ','ÊÅ®':'ÊÅ®','‰∫≤':'Ë¶™','Áñè':'Áñè','Ëøë':'Ëøë','Ëøú':'ÈÅ†','Áã¨':'Áç®','Á´ã':'Á´ã','Ëá™':'Ëá™','Áî±':'Áî±','Êùü':'Êùü','Áºö':'Á∏õ','Âõö':'Âõö','Á¶Å':'Á¶Å','Â•¥':'Â•¥','ÂΩπ':'ÂΩπ','Âéã':'Â£ì','Ëø´':'Ëø´','Áóõ':'Áóõ','Ëã¶':'Ëã¶','Èöæ':'Èõ£','Èô©':'Èö™','Â•á':'Â•á','ÊÄ™':'ÊÄ™','ËØ°':'Ë©≠','ÂºÇ':'Áï∞','Âèò':'ËÆä','Âπª':'Âπª','Ê¢¶':'Â§¢','ÈÜí':'ÈÜí','ÊÇü':'ÊÇü','Ëø∑':'Ëø∑','Ëå´':'Ëå´','Âõ∞':'Âõ∞','Êâ∞':'Êìæ','ÁÉ¶':'ÁÖ©','ÊÅº':'ÊÉ±','Ëôë':'ÊÖÆ','Ë≠¶':'Ë≠¶','ÊÉï':'ÊÉï','ÊÉß':'Êáº','ÊÄï':'ÊÄï','ÊÅê':'ÊÅê','Âç±':'Âç±'};
const S={v:'shelf',ai:null,bi:null,ci:null,sc:'s'};
let CATALOG=[],BOOKS={},currentSelection=null;
function init(){restoreSettings();fetch('books/catalog.json').then(r=>r.json()).then(d=>{CATALOG=d;buildTOC();shelf();}).catch(e=>{console.error(e);toast('Âä†ËΩΩÁõÆÂΩïÂ§±Ë¥•')});}
function buildTOC(){const p0=document.getElementById('sb-p0');p0.innerHTML='';const authors=new Map();CATALOG.forEach((b,i)=>{if(!authors.has(b.author))authors.set(b.author,[]);authors.get(b.author).push({idx:i,...b});});authors.forEach((books,author)=>{const authEl=document.createElement('div');authEl.className='sb-author';authEl.textContent=author;authEl.innerHTML+='<span class="arr">‚Ä∫</span>';authEl.onclick=(e)=>{e.stopPropagation();authEl.classList.toggle('open');};const booksEl=document.createElement('div');booksEl.className='sb-books';books.forEach(b=>{const bookEl=document.createElement('div');bookEl.className='sb-book';bookEl.innerHTML=b.title+'<span class="arr">‚Ä∫</span>';bookEl.onclick=(e)=>{e.stopPropagation();bookEl.classList.toggle('open');if(bookEl.classList.contains('open'))openBook(b.author_idx,b.idx);};const chsEl=document.createElement('div');chsEl.className='sb-chs';if(b.chapters)b.chapters.forEach((ch,j)=>{const chEl=document.createElement('div');chEl.className='sb-ch';chEl.textContent=ch.title;chEl.onclick=()=>openCh(b.author_idx,b.idx,j);chsEl.appendChild(chEl);});booksEl.appendChild(bookEl);booksEl.appendChild(chsEl);});p0.appendChild(authEl);p0.appendChild(booksEl);});}
function shelf(){S.v='shelf';setView('sv');updateCrumb('');updateTopbar();const sv=document.getElementById('sv');sv.innerHTML='<h1 class="shelf-title">Ê∏ÖÊïôÂæíÁªèÂÖ∏</h1><div class="shelf-sub">Á≤æÈÄâÂÆóÊïôÊÄùÊÉ≥ÁªèÂÖ∏Ëëó‰Ωú</div>';const authors=new Map();CATALOG.forEach(b=>{if(!authors.has(b.author))authors.set(b.author,[]);authors.get(b.author).push(b);});authors.forEach((books,author)=>{const sec=document.createElement('div');sec.className='a-section';sec.innerHTML=`<h2>${author}</h2><div class="b-grid"></div>`;const grid=sec.querySelector('.b-grid');books.forEach((b,i)=>{const rp=localStorage.getItem(`pr-rp-${b.author_idx}-${b.idx}`);const resume=rp?`<div class="resume">ÁªßÁª≠ÈòÖËØª</div>`:'';const card=document.createElement('div');card.className='b-card';card.innerHTML=`<div class="t">${b.title}</div><div class="m">${b.translator?'ËØëÔºö'+b.translator:''}</div>${resume}`;card.onclick=()=>openBook(b.author_idx,b.idx);grid.appendChild(card);});sv.appendChild(sec);});closeMobile();}
function openBook(ai,bi){const bid=`${ai}-${bi}`;const bdata=CATALOG.find(b=>b.author_idx===ai&&b.idx===bi);if(!bdata)return;S.ai=ai;S.bi=bi;S.ci=null;S.v='toc';setView('tv');updateCrumb(`${bdata.author} / ${bdata.title}`);updateTopbar();const tv=document.getElementById('tv');tv.innerHTML=`<div class="toc-hdr"><h2>${bdata.title}</h2><div class="meta">${bdata.author} | ËØëËÄÖÔºö${bdata.translator||'Êú™Áü•'}</div></div><ul class="toc-list"></ul>`;const list=tv.querySelector('.toc-list');if(BOOKS[bid]){renderTOC(BOOKS[bid],list,ai,bi);}else{tv.innerHTML=`<div class="loading"><div class="spinner"></div>Âä†ËΩΩ‰∏≠...</div>`;fetch(`books/${bid}.json`).then(r=>r.json()).then(d=>{BOOKS[bid]=d;tv.innerHTML=`<div class="toc-hdr"><h2>${bdata.title}</h2><div class="meta">${bdata.author} | ËØëËÄÖÔºö${bdata.translator||'Êú™Áü•'}</div></div><ul class="toc-list"></ul>`;renderTOC(d,tv.querySelector('.toc-list'),ai,bi);}).catch(e=>{console.error(e);toast('Âä†ËΩΩ‰π¶Á±çÂ§±Ë¥•');});}closeMobile();}
function renderTOC(book,list,ai,bi){const bid=`${ai}-${bi}`;const rp=localStorage.getItem(`pr-rp-${bid}`);const [rpci]=rp?rp.split(':'):[null];if(rp){const item=document.createElement('li');item.className='toc-item';item.innerHTML=`<div class="n">üìç</div><div><div class="ct">ÁªßÁª≠ÈòÖËØª</div></div>`;item.onclick=()=>openCh(ai,bi,parseInt(rpci));list.appendChild(item);}book.chapters.forEach((ch,i)=>{const item=document.createElement('li');item.className='toc-item';const pc=ch.paragraphs.length;item.innerHTML=`<div class="n">${i+1}</div><div><div class="ct">${ch.title}</div><div class="cc">${pc}ÊÆµ</div></div>`;item.onclick=()=>openCh(ai,bi,i);list.appendChild(item);});}
function openCh(ai,bi,ci){const bid=`${ai}-${bi}`;const book=BOOKS[bid];if(!book){toast('‰π¶Á±çÊú™Âä†ËΩΩ');return;}const ch=book.chapters[ci];if(!ch){toast('Á´†ËäÇ‰∏çÂ≠òÂú®');return;}S.ai=ai;S.bi=bi;S.ci=ci;S.v='reader';setView('rv');const bdata=CATALOG.find(b=>b.author_idx===ai&&b.idx===bi);updateCrumb(`${bdata.author} / ${bdata.title} / ${ch.title}`);updateTopbar();const rv=document.getElementById('rv');rv.innerHTML=`<h2 class="ch-title">${ch.title}</h2><div id="ch-c"></div><div class="rnav"><button onclick="prevCh()">‰∏ä‰∏ÄÁ´†</button><div class="pi"><span id="cp">${ci+1}</span>/<span id="tc">${book.chapters.length}</span></div><button onclick="nextCh()">‰∏ã‰∏ÄÁ´†</button></div>`;const chc=rv.querySelector('#ch-c');ch.paragraphs.forEach((p,pi)=>{const para=document.createElement('p');para.className='para';para.dataset.pi=pi;para.textContent=S.sc==='t'?simplifiedToTraditional(p):p;chc.appendChild(para);});restoreHighlights(ai,bi,ci);localStorage.setItem(`pr-rp-${bid}`,`${ci}:0`);chc.addEventListener('mouseup',onTextSelect);chc.addEventListener('touchend',onTextSelect);closeMobile();}
function onTextSelect(){const sel=window.getSelection();if(!sel.toString()){document.getElementById('hl-toolbar').classList.remove('show');currentSelection=null;return;}currentSelection=sel;const tb=document.getElementById('hl-toolbar');tb.classList.add('show');const range=sel.getRangeAt(0);const rect=range.getBoundingClientRect();tb.style.left=(rect.left+window.scrollX)+'px';tb.style.top=(rect.top+window.scrollY-50)+'px';}
function applyHL(color){if(!currentSelection)return;const text=currentSelection.toString();if(!text)return;const hid=Date.now().toString(36)+Math.random().toString(36).substr(2);const range=currentSelection.getRangeAt(0);const span=document.createElement('span');span.className=`hl-${color}`;span.dataset.hid=hid;span.textContent=text;range.deleteContents();range.insertNode(span);saveHighlight(S.ai,S.bi,S.ci,hid,text,color);document.getElementById('hl-toolbar').classList.remove('show');currentSelection=null;renderHL();}
function removeHL(){if(!currentSelection)return;document.getElementById('hl-toolbar').classList.remove('show');currentSelection=null;}
function saveHighlight(ai,bi,ci,id,text,color){const key=`pr-hl-${ai}-${bi}-${ci}`;let hls=JSON.parse(localStorage.getItem(key)||'[]');hls.push({id,text,color,date:new Date().toISOString()});localStorage.setItem(key,JSON.stringify(hls));}
function restoreHighlights(ai,bi,ci){const key=`pr-hl-${ai}-${bi}-${ci}`;const hls=JSON.parse(localStorage.getItem(key)||'[]');const chc=document.getElementById('ch-c');hls.forEach(h=>{const paras=chc.querySelectorAll('.para');paras.forEach(p=>{const text=p.textContent;if(text.includes(h.text)){const html=p.innerHTML;const newHtml=html.replace(h.text,`<span class="hl-${h.color}" data-hid="${h.id}">${h.text}</span>`);p.innerHTML=newHtml;}});});}
function renderHL(){const panel=document.getElementById('sb-p2');panel.innerHTML='';let allHL=[];const keys=Object.keys(localStorage).filter(k=>k.startsWith('pr-hl-'));keys.forEach(key=>{const hls=JSON.parse(localStorage.getItem(key)||'[]');const [,ai,bi,ci]=key.split('-');const bdata=CATALOG.find(b=>b.author_idx===parseInt(ai)&&b.idx===parseInt(bi));const book=BOOKS[`${ai}-${bi}`];const ch=book&&book.chapters[ci];if(bdata&&ch){hls.forEach(h=>{allHL.push({...h,ai,bi,ci,book:bdata.title,chapter:ch.title});})}});if(!allHL.length){panel.innerHTML='<div class="empty">ËøòÊ≤°ÊúâÂàíÁ∫ø</div>';return;}allHL.sort((a,b)=>new Date(b.date)-new Date(a.date));allHL.forEach(h=>{const item=document.createElement('div');item.className='hl-item';const colorMap={y:'#ffeb3b',g:'#4caf50',b:'#42a5f5',p:'#ec409e'};item.innerHTML=`<div class="hl-text"><span class="hl-color" style="background:${colorMap[h.color]}"></span>${h.text}</div><div class="hl-meta">${h.book} ‚Ä¢ ${h.chapter}</div>`;item.onclick=()=>openCh(parseInt(h.ai),parseInt(h.bi),parseInt(h.ci));panel.appendChild(item);});}
function goBack(){if(S.v==='reader')openBook(S.ai,S.bi);else if(S.v==='toc')shelf();}
function prevCh(){if(S.ci>0)openCh(S.ai,S.bi,S.ci-1);}
function nextCh(){const book=BOOKS[`${S.ai}-${S.bi}`];if(S.ci<book.chapters.length-1)openCh(S.ai,S.bi,S.ci+1);}
function toggleSB(){const sb=document.getElementById('sidebar');const main=document.getElementById('main');const ov=document.getElementById('overlay');const w=window.innerWidth;if(w>=768){sb.classList.toggle('hidden');main.classList.toggle('full');}else{sb.classList.toggle('vis');ov.classList.toggle('show');}}
function closeMobile(){const sb=document.getElementById('sidebar');const ov=document.getElementById('overlay');const w=window.innerWidth;if(w<768){sb.classList.remove('vis');ov.classList.remove('show');}}
function sbTab(n,el){const tabs=el.parentNode.querySelectorAll('.sb-tab');tabs.forEach(t=>t.classList.remove('act'));el.classList.add('act');const panels=document.querySelectorAll('.sb-panel');panels.forEach(p=>p.classList.remove('act'));if(n===2)renderHL();document.getElementById(`sb-p${n}`).classList.add('act');}
function toggleSrch(){const inp=document.getElementById('search-input');inp.classList.toggle('open');if(inp.classList.contains('open'))inp.focus();else inp.value='';}
function onSrch(){const q=document.getElementById('search-input').value.trim().toLowerCase();if(!q){setView('sv');shelf();return;}S.v='search';setView('xv');updateCrumb(`ÊêúÁ¥¢: ${q}`);const xv=document.getElementById('xv');xv.innerHTML='';let results=[];Object.entries(BOOKS).forEach(([bid,book])=>{const [ai,bi]=bid.split('-').map(Number);const bdata=CATALOG.find(b=>b.author_idx===ai&&b.idx===bi);book.chapters.forEach((ch,ci)=>{ch.paragraphs.forEach((p,pi)=>{if(p.toLowerCase().includes(q)){results.push({ai,bi,ci,text:p,book:bdata.title,chapter:ch.title,pi});}});});});if(!results.length){xv.innerHTML='<div class="empty">Ê≤°ÊúâÊâæÂà∞Áõ∏ÂÖ≥ÂÜÖÂÆπ</div>';return;}results.slice(0,50).forEach(r=>{const idx=r.text.toLowerCase().indexOf(q);const start=Math.max(0,idx-30);const end=Math.min(r.text.length,idx+q.length+30);const snippet=r.text.substring(start,end);const marked=snippet.replace(new RegExp(q,'gi'),m=>`<mark>${m}</mark>`);const res=document.createElement('div');res.className='sr';res.innerHTML=`<div class="st">${r.book} ‚Ä¢ ${r.chapter}</div><div class="sx">${marked}</div>`;res.onclick=()=>openCh(r.ai,r.bi,r.ci);xv.appendChild(res);});}
function toggleBM(){const bid=`${S.ai}-${S.bi}`;if(S.v!=='reader'||!bid)return;let bms=JSON.parse(localStorage.getItem('pr-bm')||'[]');const exists=bms.find(b=>b.ai===S.ai&&b.bi===S.bi&&b.ci===S.ci);if(exists){bms=bms.filter(b=>!(b.ai===S.ai&&b.bi===S.bi&&b.ci===S.ci));}else{const bdata=CATALOG.find(b=>b.author_idx===S.ai&&b.idx===S.bi);const book=BOOKS[bid];const ch=book.chapters[S.ci];bms.push({ai:S.ai,bi:S.bi,ci:S.ci,book:bdata.title,chapter:ch.title,date:new Date().toISOString()});}localStorage.setItem('pr-bm',JSON.stringify(bms));updateTopbar();renderBM();}
function renderBM(){const panel=document.getElementById('sb-p1');panel.innerHTML='';const bms=JSON.parse(localStorage.getItem('pr-bm')||'[]');if(!bms.length){panel.innerHTML='<div class="empty">ËøòÊ≤°Êúâ‰π¶Á≠æ</div>';return;}bms.sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(bm=>{const item=document.createElement('div');item.className='bm-item';item.innerHTML=`<div class="bm-title">${bm.book}</div><div class="bm-info">${bm.chapter}</div><span class="bm-del" onclick="delBM(${bm.ai},${bm.bi},${bm.ci},event)">‚úï</span>`;item.onclick=()=>openCh(bm.ai,bm.bi,bm.ci);panel.appendChild(item);});}
function delBM(ai,bi,ci,e){e.stopPropagation();let bms=JSON.parse(localStorage.getItem('pr-bm')||'[]');bms=bms.filter(b=>!(b.ai===ai&&b.bi===bi&&b.ci===ci));localStorage.setItem('pr-bm',JSON.stringify(bms));renderBM();updateTopbar();}
function updateTopbar(){const btn=document.getElementById('bm-btn');if(S.v==='reader'){const bms=JSON.parse(localStorage.getItem('pr-bm')||'[]');const exists=bms.find(b=>b.ai===S.ai&&b.bi===S.bi&&b.ci===S.ci);btn.classList.toggle('bookmarked',!!exists);btn.style.display='flex';}else{btn.style.display='none';}const back=document.getElementById('back');back.style.display=(S.v==='toc'||S.v==='reader')?'flex':'none';}
function updateCrumb(text){const crumb=document.getElementById('crumb');if(!text){crumb.textContent='';return;}const parts=text.split(' / ');crumb.innerHTML=parts.map((p,i)=>`<span>${p}</span>${i<parts.length-1?'<span class="sep">/</span>':''}`).join('');}
function openSets(){document.getElementById('settings').classList.add('open');document.getElementById('set-overlay').classList.add('show');}
function closeSets(){document.getElementById('settings').classList.remove('open');document.getElementById('set-overlay').classList.remove('show');}
function setFS(v){document.getElementById('fs-val').textContent=v;document.body.style.fontSize=v+'px';localStorage.setItem('pr-fs',v);}
function setLH(v){document.getElementById('lh-val').textContent=v;document.body.style.lineHeight=v;localStorage.setItem('pr-lh',v);}
function setFF(type,el){const btns=el.parentNode.querySelectorAll('.sb');btns.forEach(b=>b.classList.remove('act'));el.classList.add('act');const fonts={serif:'var(--serif)',sans:'var(--sans)',kai:'var(--kai)'};document.documentElement.style.setProperty('--reading-font',fonts[type]);localStorage.setItem('pr-ff',type);}
function setSC(mode,el){const btns=el.parentNode.querySelectorAll('.sb');btns.forEach(b=>b.classList.remove('act'));el.classList.add('act');S.sc=mode;localStorage.setItem('pr-sc',mode);if(S.v==='reader')refreshReader();}
function setTh(theme,el){const btns=el.parentNode.querySelectorAll('.sb');btns.forEach(b=>b.classList.remove('act'));el.classList.add('act');document.documentElement.setAttribute('data-theme',theme==='dark'?'dark':'light');localStorage.setItem('pr-theme',theme);}
function restoreSettings(){const fs=localStorage.getItem('pr-fs')||'17';const lh=localStorage.getItem('pr-lh')||'1.9';const ff=localStorage.getItem('pr-ff')||'serif';const sc=localStorage.getItem('pr-sc')||'s';const theme=localStorage.getItem('pr-theme')||'light';document.body.style.fontSize=fs+'px';document.body.style.lineHeight=lh;document.documentElement.style.setProperty('--reading-font',{serif:'var(--serif)',sans:'var(--sans)',kai:'var(--kai)'}[ff]);document.documentElement.setAttribute('data-theme',theme==='dark'?'dark':'light');S.sc=sc;document.getElementById('fs-val').textContent=fs;document.getElementById('lh-val').textContent=lh;const ffBtns=document.querySelectorAll('.sg:nth-child(3) .sb');ffBtns.forEach((b,i)=>b.classList.toggle('act',['serif','sans','kai'][i]===ff));const scBtns=document.querySelectorAll('.sg:nth-child(4) .sb');scBtns.forEach((b,i)=>b.classList.toggle('act',['s','t'][i]===sc));const thBtns=document.querySelectorAll('.sg:nth-child(5) .sb');thBtns.forEach((b,i)=>b.classList.toggle('act',['light','dark'][i]===theme));}
function refreshReader(){if(S.v!=='reader')return;const bid=`${S.ai}-${S.bi}`;const book=BOOKS[bid];const ch=book.chapters[S.ci];const chc=document.getElementById('ch-c');chc.innerHTML='';ch.paragraphs.forEach((p,pi)=>{const para=document.createElement('p');para.className='para';para.dataset.pi=pi;para.textContent=S.sc==='t'?simplifiedToTraditional(p):p;chc.appendChild(para);});restoreHighlights(S.ai,S.bi,S.ci);}
function simplifiedToTraditional(text){let result='';for(let char of text){result+=S2T_MAP[char]||char;}return result;}
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500);}
function setView(vid){document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));document.getElementById(vid).classList.add('active');}
document.addEventListener('keydown',e=>{if(e.key==='Escape'){closeSets();document.getElementById('hl-toolbar').classList.remove('show');}});
window.addEventListener('resize',()=>{if(window.innerWidth>=768){document.getElementById('sidebar').classList.remove('vis');document.getElementById('overlay').classList.remove('show');}});
init();
  </script>
</body>
</html>
